<section id="gallery" [class.gallery--route]="isGalleryRoute">
  <div class="container">
    <header class="text-center px-3 px-md-5 mb-4 mb-md-5">
      <h2 class="gallery__title mb-2">Gallery</h2>
      <p class="gallery__tagline mb-2">Moments from our Yacht Experiences</p>
      <p class="gallery__description mb-0">
        Tap any photo or video to view in full. For best quality, open the full gallery.
      </p>
    </header>

    <div class="row g-3 g-md-4" role="list">
      <div
        *ngFor="let item of items(); let i = index"
        class="col-6 col-md-4 col-xl-3"
        role="listitem"
      >
        <button
          class="gallery-card w-100"
          type="button"
          (click)="open(item)"
          [attr.aria-label]="item.kind === 'image' ? item.alt : item.title"
          [style.--d.ms]="(i % 12) * 30"
        >
          <img
            class="gallery-thumb"
            [src]="item.thumbUrl"
            [alt]="item.kind === 'image' ? item.alt : item.title"
            loading="lazy"
            decoding="async"
          />

          <span class="gallery-badge" *ngIf="item.kind === 'video'" aria-hidden="true">
            Video
          </span>
          <span class="gallery-sheen" aria-hidden="true"></span>
        </button>
      </div>
    </div>

    <!-- Home/embed only -->
    <div class="text-center mt-4" *ngIf="!isFullPage()">
      <button class="btn btn-primary btn-lg sr-cta" type="button" (click)="seeMore()">
        See More Photos &amp; Videos
      </button>
    </div>

    <!-- /gallery only: sentinel for scroll loading -->
    <div
      *ngIf="isFullPage()"
      #infiniteSentinel
      class="infinite-sentinel"
      aria-hidden="true"
    ></div>

    <!-- Lightbox -->
    <div class="modal-backdrop" *ngIf="isOpen()"></div>

    <div class="modal" *ngIf="isOpen()" role="dialog" aria-modal="true" (click)="close()">
      <div
        class="modal-shell"
        (click)="stopPropagation($event)"
        (touchstart)="onTouchStart($event)"
        (touchend)="onTouchEnd($event)"
      >
        <div class="modal-topbar">
          <button class="icon-btn close" type="button" (click)="close()" aria-label="Close">
            <span aria-hidden="true">✕</span>
          </button>
        </div>

        <button class="nav-btn left" type="button" (click)="prev()" aria-label="Previous">
          <span aria-hidden="true">‹</span>
        </button>
        <button class="nav-btn right" type="button" (click)="next()" aria-label="Next">
          <span aria-hidden="true">›</span>
        </button>

        <ng-container *ngIf="activeItem() as active">
          <img
            *ngIf="active.kind === 'image'"
            class="full"
            [src]="active.fullUrl"
            [alt]="active.alt"
            decoding="async"
          />

          <ng-container *ngIf="active.kind === 'video'">
            <ng-container *ngIf="shouldLoadVideo(); else videoThumb">
              <video
                *ngIf="active.provider !== 'youtube'; else youtubeEmbed"
                class="full"
                controls
                autoplay
                playsinline
                preload="metadata"
                [attr.poster]="active.thumbUrl"
              >
                <source [src]="active.videoUrl" type="video/mp4" />
              </video>

              <ng-template #youtubeEmbed>
                <iframe
                  class="full"
                  [src]="safeEmbedUrl()!"
                  [title]="active.title"
                  loading="lazy"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                ></iframe>
              </ng-template>
            </ng-container>

            <ng-template #videoThumb>
              <img class="full" [src]="active.thumbUrl" [alt]="active.title" />
            </ng-template>
          </ng-container>
        </ng-container>

        <div class="modal-hint" aria-hidden="true">
          <span class="hint-pill desktop-only">Esc to close</span>
          <span class="hint-pill desktop-only">← / → to navigate</span>
          <span class="hint-pill mobile-only">Swipe to navigate</span>
        </div>
      </div>
    </div>
  </div>
</section>